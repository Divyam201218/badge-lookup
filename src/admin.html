<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì Badge Lookup</title>

  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --accent: #6366f1;
    }

    body.dark {
      --bg: #0f172a;
      --card: #020617;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #1e293b;
      --accent: #818cf8;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 32px 20px;
    }

    h1, h2, h3 {
      margin: 0 0 12px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }

    button.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
    }

    .hidden { display: none; }

    /* Login */
    .login-box {
      max-width: 400px;
      margin: 100px auto;
      background: var(--card);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .login-box input {
      margin-bottom: 10px;
    }

    /* Cards */
    .email-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .email-header {
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--accent);
      word-break: break-all;
    }

    .badge-row {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1fr 2fr auto;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    .badge-row small {
      color: var(--muted);
    }

    .badge-row button {
      padding: 6px 10px;
    }

    .csv-box {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--card);
      border: 1px dashed var(--border);
      border-radius: 12px;
    }
    .modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 40;
}

.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  width: 360px;
  z-index: 50;
}

.modal input {
  margin-bottom: 8px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
    .badge-group {
  margin-top: 12px;
}
.email-header {
  cursor: pointer;
}
.email-header small {
  color: var(--muted);
  font-weight: normal;
}
.badge-row button.secondary {
  opacity: 0.7;
}
.badge-row button.secondary:hover {
  opacity: 1;
  color: #ef4444;
}


  </style>
</head>

<body>
<div class="container">

  <!-- LOGIN -->
  <div id="loginBox" class="login-box">
    <h2>Admin Login</h2>
    <input id="username" placeholder="Username" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <p id="loginErr" style="color:red;"></p>
  </div>

  <!-- ADMIN -->
  <div id="adminBox" class="hidden">

    <div class="topbar">
      <h1>Badge Admin Panel</h1>
      <div>
  <button onclick="openModal('addModal')">‚ûï Add Badge</button>
  <button class="secondary" onclick="openModal('transferModal')">üîÅ Transfer</button>
</div>

      <button class="secondary" onclick="toggleDark()">üåô Toggle Dark</button>
    </div>

    <div class="csv-box">
      <h3>Upload CSV</h3>
      <input type="file" accept=".csv" onchange="uploadCSV(this)">
    </div>
<div class="csv-box">
  <h3>Filter Badges</h3>
  <input id="filter" placeholder="Search by email, name, series, date, link" oninput="applyFilter()">
</div>

        <div id="data"></div>
  <!-- MODAL BACKDROP -->
<div id="modalBackdrop" class="modal-backdrop hidden" onclick="closeModal()"></div>

<!-- ADD BADGE MODAL -->
<div id="addModal" class="modal hidden">
  <h3>Add Badge</h3>
  <input id="m-email" placeholder="Email">
  <input id="m-series" placeholder="Series">
  <input id="m-name" placeholder="Name">
  <input id="m-issued" placeholder="Issued Date">
  <input id="m-link" placeholder="Badge Link">
  <div class="modal-actions">
    <button onclick="addManual()">Save</button>
    <button class="secondary" onclick="closeModal()">Cancel</button>
  </div>
</div>

<!-- TRANSFER MODAL -->
<div id="transferModal" class="modal hidden">
  <h3>Transfer Badges</h3>
  <input id="t-from" placeholder="Old Email">
  <input id="t-to" placeholder="New Email">
  <div class="modal-actions">
    <button onclick="transfer()">Transfer</button>
    <button class="secondary" onclick="closeModal()">Cancel</button>
  </div>
</div>


<script>
  let RAW_DATA = {};

let adminPassword = "";

/* ---------- THEME ---------- */
function toggleDark() {
  document.body.classList.toggle("dark");
  localStorage.setItem("dark", document.body.classList.contains("dark"));
}
if (localStorage.getItem("dark") === "true") {
  document.body.classList.add("dark");
}

/* ---------- AUTH ---------- */
async function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const res = await fetch("/.netlify/functions/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

  if (res.status !== 200) {
    document.getElementById("loginErr").innerText = "Invalid credentials";
    return;
  }

  adminPassword = password;
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("adminBox").classList.remove("hidden");
  loadData();
}

/* ---------- DATA ---------- */
async function loadData() {
  const res = await fetch("/.netlify/functions/fetch", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: adminPassword })
  });

  RAW_DATA = await res.json();
  render(RAW_DATA);

}

function render(data) {
  const container = document.getElementById("data");
  container.innerHTML = "";

  Object.entries(data).forEach(([email, badges]) => {
    const card = document.createElement("div");
    card.className = "email-card";

    let html = `
      <div class="email-header" onclick="this.nextElementSibling.classList.toggle('hidden')">
        ${email} <small>(click to expand)</small>
      </div>
      <div class="badge-group hidden">
    `;

    badges.forEach(b => {
      html += `
        <div class="badge-row">
          <input value="${b.series}" disabled />
          <input id="name-${email}-${b.series}" value="${b.name}" />
          <input id="issued-${email}-${b.series}" value="${b.issued}" />
          <input id="link-${email}-${b.series}" value="${b.link}" />
          <button onclick="save('${email}','${b.series}')">Save</button>
          <button class="secondary" onclick="delBadge('${email}','${b.series}')">üóë</button>

        </div>
      `;
    });

    html += `</div>`; // ‚úÖ close badge-group here

    card.innerHTML = html;
    container.appendChild(card);
  });
}


/* ---------- SAVE ---------- */
async function save(email, series) {
  const name = document.getElementById(`name-${email}-${series}`).value;
  const issued = document.getElementById(`issued-${email}-${series}`).value;
  const link = document.getElementById(`link-${email}-${series}`).value;

  await fetch("/.netlify/functions/save", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, series, name, issued, link })
  });

  alert("Saved");
}

/* ---------- CSV ---------- */
async function uploadCSV(input) {
  const file = input.files[0];
  const text = await file.text();

  await fetch("/.netlify/functions/save-csv", {
    method: "POST",
    headers: { "Content-Type": "text/csv" },
    body: text
  });

  alert("CSV processed");
  loadData();
}
async function addManual() {
  const payload = {
    email: document.getElementById("m-email").value,
    series: document.getElementById("m-series").value,
    name: document.getElementById("m-name").value,
    issued: document.getElementById("m-issued").value,
    link: document.getElementById("m-link").value
  };

  await fetch("/.netlify/functions/save", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  alert("Badge added");
  loadData();
}

async function transfer() {
  if (!confirm("This will MOVE all badges. Continue?")) return;

  const from = document.getElementById("t-from").value;
  const to = document.getElementById("t-to").value;

  const res = await fetch("/.netlify/functions/transfer-email", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ from, to })
  });

  if (res.status !== 200) {
    alert("Transfer failed");
    return;
  }

  alert("Transfer complete");
  loadData();
}
  function openModal(id) {
  document.getElementById("modalBackdrop").classList.remove("hidden");
  document.getElementById(id).classList.remove("hidden");
}

function closeModal() {
  document.getElementById("modalBackdrop").classList.add("hidden");
  document.querySelectorAll(".modal").forEach(m => m.classList.add("hidden"));
}
function applyFilter() {
  const q = document.getElementById("filter").value.toLowerCase();
  const filtered = {};

  Object.entries(RAW_DATA).forEach(([email, badges]) => {
    const matches = badges.filter(b =>
      email.toLowerCase().includes(q) ||
      b.series.toLowerCase().includes(q) ||
      b.name.toLowerCase().includes(q) ||
      b.issued.toLowerCase().includes(q) ||
      b.link.toLowerCase().includes(q)
    );

    if (matches.length) {
      filtered[email] = matches;
    }
  });

  render(filtered);
}
  async function delBadge(email, series) {
  if (!confirm(`Delete badge "${series}" for ${email}?`)) return;

  const res = await fetch("/.netlify/functions/delete-badge", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, series })
  });

  if (res.status !== 200) {
    alert("Delete failed");
    return;
  }

  alert("Badge deleted");
  loadData();
}



</script>

</body>
</html>
